# MPU6050 计步器测试步骤

## ✅ 代码已准备完成

### 已修改的文件
1. **`APP/mpu_app.c`** - 在 `MPU6050_Update()` 中添加了计步器数据更新
2. **`Core/Src/main.c`** - 添加了完整的测试代码

---

## 📋 测试前检查清单

### 1. 硬件连接

```
STM32 ←→ MPU6050
- PB6 (SCL) ← SCL
- PB7 (SDA) ← SDA  
- 3.3V ← VCC
- GND ← GND

串口连接：
- PA9 (TX) → USB转TTL RX
- PA10(RX) → USB转TTL TX
- GND → GND
```

### 2. 软件准备

```
✓ CLion/STM32CubeIDE 已打开项目
✓ 串口工具已准备（推荐：MobaXterm / PuTTY / 串口助手）
✓ 波特率设置：115200, 8N1
```

---

## 🚀 测试步骤

### 步骤 1: 编译下载

```bash
1. 在 CLion 中点击 "Build" (Ctrl+F9)
2. 等待编译完成（无错误）
3. 点击 "Run" 下载到 STM32
4. 等待下载完成
```

**预期结果：**
```
✓ 编译成功：100% 
✓ 下载成功
✓ 设备自动复位
```

---

### 步骤 2: 打开串口

```bash
1. 打开串口工具
2. 选择正确的 COM 口
3. 设置波特率：115200
4. 打开串口
```

**预期输出（初始化信息）：**
```
OLED Init OK
DHT11 Init OK
MPU6050 DMP Init: 0
DMP Init Success!
=== MPU6050 计步器测试开始 ===
请将设备固定在腰部，然后正常行走测试
Scheduler Init OK
OLED Labels OK
```

如果看到这些信息，说明初始化成功！✅

---

### 步骤 3: 静止测试（验证基本功能）

**操作：**
1. 将设备平放在桌面
2. 保持静止 5 秒
3. 观察串口输出

**预期输出（每秒更新）：**
```
--- MPU6050 数据 ---
姿态: Pitch=0.5° Roll=-0.3° Yaw=12.4°
加速度: X=156 Y=-234 Z=16234 (SVM=16384)
计步器: 步数=0  距离=0.00m (0.000km)
-------------------
```

**检查点：**
- ✅ 姿态角度稳定（变化 < ±2°）
- ✅ SVM 约等于 16384（1g）
- ✅ 步数为 0（静止不计步）

---

### 步骤 4: 计步器测试（核心测试）

#### 4.1 正确的安装方法 ⭐⭐⭐⭐⭐

```
最佳位置：腰部/腰带
┌─────────────┐
│   头部      │
└─────────────┘
      ▼
┌─────────────┐
│   胸口      │
└─────────────┘
      ▼
┌─────────────┐
│ ⭐ 腰部 ⭐  │ ← 将设备固定在这里！
│  [MPU6050]  │    (用腰带/皮带固定)
└─────────────┘
      ▼
┌─────────────┐
│    腿部     │
└─────────────┘

方向要求：
- Z轴垂直向上 ↑
- Y轴指向前方 →
- 固定牢固，不要松动
```

#### 4.2 测试操作

**操作流程：**

```
1️⃣ 准备阶段
   - 将设备用腰带固定在腰部
   - 确保固定牢固
   - 检查串口连接正常
   - 等待串口显示稳定

2️⃣ 重置计数
   - 按下复位按钮（或重新上电）
   - 等待初始化完成
   - 确认步数为 0

3️⃣ 行走测试
   - 像平时一样正常行走
   - 保持稳定步速（不要太快）
   - 行走 20 步（数清楚！）
   - 不要停顿

4️⃣ 观察结果
   - 查看串口输出
   - 记录检测到的步数
```

**预期输出（行走时）：**

```
--- MPU6050 数据 ---
姿态: Pitch=2.3° Roll=-1.2° Yaw=45.6°
加速度: X=1234 Y=2345 Z=15234 (SVM=17234)
计步器: 步数=1  距离=0.35m (0.000km)
✓ 新增 1 步！
-------------------

--- MPU6050 数据 ---
姿态: Pitch=3.1° Roll=-0.8° Yaw=46.2°
加速度: X=2123 Y=3456 Z=14567 (SVM=18123)
计步器: 步数=2  距离=0.70m (0.001km)
✓ 新增 1 步！
-------------------

--- MPU6050 数据 ---
姿态: Pitch=2.8° Roll=-1.5° Yaw=46.8°
加速度: X=1876 Y=2987 Z=15987 (SVM=17654)
计步器: 步数=3  距离=1.05m (0.001km)
✓ 新增 1 步！
-------------------

... (继续行走)

--- MPU6050 数据 ---
计步器: 步数=20  距离=7.00m (0.007km)
✓ 新增 1 步！
-------------------
```

**成功标准：**

```
实际行走：20 步
检测步数：18-22 步
精度：90-110%
结论：✅ 测试通过

误差范围：
- ±10% 是正常的
- ±20% 需要调整安装位置
- > ±30% 说明安装或测试方法有问题
```

---

### 步骤 5: 精度校准测试

**操作：**

1. 在地上标记起点
2. 正常行走 10 步
3. 标记终点
4. 用卷尺测量距离
5. 计算步距

**计算方法：**

```
假设：
- 行走 10 步
- 测量距离 = 3.8 米

步距 = 距离 / 步数
     = 3.8 / 10
     = 0.38 米

修改代码：
MPU6050_SetStepLength(0.38f);  // 改为实测步距
```

重新编译下载后，距离会更准确！

---

## 📊 预期测试结果

### 正常情况（成功）✅

```
静止状态：
- 步数保持不变
- SVM ≈ 16384 (1g)
- 姿态角度稳定

行走状态：
- 步数逐步增加
- 每步检测成功率 > 85%
- 距离 = 步数 × 步距
- SVM 有明显波动 (14000-19000)

控制台输出：
- 每秒更新一次数据
- 步数变化时显示 "✓ 新增 X 步！"
- 无异常报错
```

### 异常情况（需要排查）❌

#### 问题 1: 步数一直是 0

**可能原因：**
```
□ DMP 初始化失败
□ 没有真实行走（原地摇晃）
□ 安装位置不对
□ 步频过快或过慢
```

**排查方法：**
```
1. 检查串口初始化信息
   ✓ 是否显示 "DMP Init Success!"
   
2. 检查 SVM 值
   ✓ 行走时是否有变化（应该波动）
   
3. 检查行走方式
   ✓ 是否正常抬脚行走
   ✓ 不要原地快速摇晃
   
4. 调整安装位置
   ✓ 固定在腰部中央
   ✓ 确保牢固
```

#### 问题 2: 步数跳变很大

**可能原因：**
```
□ 剧烈晃动
□ 安装不稳固
□ 频繁跳动
```

**解决方法：**
```
1. 固定更牢固
2. 避免剧烈晃动
3. 正常行走测试
```

#### 问题 3: 步数明显偏少

**可能原因：**
```
□ 步态不明显（拖着走）
□ 安装位置不佳
□ 步频过快
```

**解决方法：**
```
1. 正常抬脚行走
2. 调整到腰部
3. 放慢步速
```

#### 问题 4: 串口无输出

**可能原因：**
```
□ 串口线松动
□ COM 口选错
□ 波特率不对（应该是 115200）
□ 设备未上电
```

**排查方法：**
```
1. 检查硬件连接
2. 重新选择 COM 口
3. 确认波特率 115200
4. 按复位按钮
```

---

## 🎯 成功判断标准

### ✅ 测试通过的标志

```
1. 初始化成功
   ✓ 串口显示 "DMP Init Success!"
   
2. 数据更新正常
   ✓ 每秒打印一次数据
   ✓ 姿态角度有变化
   ✓ SVM 值合理
   
3. 计步器工作
   ✓ 行走时步数增加
   ✓ 检测精度 > 80%
   ✓ 距离 = 步数 × 步距
   
4. 稳定性好
   ✓ 静止时不误计
   ✓ 行走时不漏计
   ✓ 无异常复位
```

### ❌ 需要继续调试的情况

```
1. 步数一直是 0
2. 步数误差 > 30%
3. 数据不更新
4. 频繁复位
```

---

## 📹 测试视频参考

### 正确的测试方法（录制要点）

```
1. 展示设备安装位置（腰部）
2. 展示串口输出（初始化成功）
3. 开始行走（正常步态）
4. 展示步数变化（实时更新）
5. 停止后展示最终结果
```

### 测试数据记录

```
测试记录表：

测试次数：_________
实际步数：_________ 步
检测步数：_________ 步
精度：_____________ %
安装位置：_________
测试环境：_________
备注：_____________
```

---

## 🔄 重复测试建议

### 多次测试验证

```
第1次：20 步 → 检测 ___ 步 → 精度 ____%
第2次：20 步 → 检测 ___ 步 → 精度 ____%
第3次：20 步 → 检测 ___ 步 → 精度 ____%

平均精度：_____%
```

### 不同条件测试

```
□ 平地行走
□ 上楼梯
□ 下楼梯
□ 快走
□ 慢走
□ 不同安装位置
```

---

## 🆘 获取帮助

### 如果测试失败

1. **查看调试指南**
   ```
   📄 MPU6050_计步器调试指南.md
   ```

2. **检查代码示例**
   ```
   📄 计步器测试代码示例.c
   ```

3. **提供以下信息**
   ```
   - 串口完整输出
   - 测试方法描述
   - 实际步数 vs 检测步数
   - 安装位置照片
   - 代码修改说明
   ```

---

## 📊 测试完成报告模板

```
========================================
MPU6050 计步器测试报告
========================================

日期：2025-11-11
测试人员：________

一、硬件信息
- MCU：STM32F103
- 传感器：MPU6050
- 连接方式：I2C (PB6/PB7)

二、软件版本
- DMP 固件：已加载
- 代码版本：2025-11-11

三、测试结果

1. 初始化测试
   □ OLED 初始化：成功
   □ DHT11 初始化：成功
   □ MPU6050 DMP 初始化：成功
   
2. 静止测试
   □ 步数保持0：通过
   □ SVM值稳定：通过
   □ 姿态稳定：通过

3. 计步器测试
   测试1：
   - 实际步数：20
   - 检测步数：___
   - 精度：_____%
   - 结论：______
   
   测试2：
   - 实际步数：20
   - 检测步数：___
   - 精度：_____%
   - 结论：______
   
   平均精度：_____%

4. 距离测试
   - 设定步距：0.35m
   - 实际距离：___m
   - 计算距离：___m
   - 误差：_____%

四、问题记录
___________________________
___________________________
___________________________

五、总体评价
□ 优秀 (精度 > 90%)
□ 良好 (精度 80-90%)
□ 一般 (精度 70-80%)
□ 需改进 (精度 < 70%)

六、改进建议
___________________________
___________________________
___________________________

========================================
```

---

## ✅ 快速测试清单

```
开始测试前，逐项确认：

硬件准备：
□ MPU6050 连接正确
□ 串口线已连接
□ 设备已上电

软件准备：
□ 代码已编译
□ 已下载到 STM32
□ 串口工具已打开
□ 波特率设置 115200

测试环境：
□ 设备固定在腰部
□ 固定牢固
□ 方向正确
□ 测试场地充足（可走20步）

开始测试：
□ 按复位按钮
□ 确认初始化成功
□ 步数重置为 0
□ 开始正常行走
□ 观察串口输出
□ 记录测试结果
```

---

## 🎉 预期最终效果

当一切正常时，您应该看到：

```
设备状态：
✓ 固定在腰部
✓ LED 正常闪烁
✓ OLED 显示加速度

串口输出：
✓ 每秒更新数据
✓ 行走时步数递增
✓ 距离同步更新
✓ 步数变化有提示

精度表现：
✓ 20步检测 18-22步
✓ 误差 < 10%
✓ 无误触发
✓ 稳定可靠
```

**恭喜！计步器测试成功！** 🎊

---

## 📞 技术支持

如有问题，请提供：
1. 串口完整输出截图
2. 测试方法详细描述
3. 测试数据记录
4. 问题现象描述

祝测试顺利！✨

