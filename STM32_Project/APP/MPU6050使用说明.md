# MPU6050 é©±åŠ¨ä½¿ç”¨è¯´æ˜

## ğŸ“‹ æ¦‚è¿°

æœ¬é©±åŠ¨æ˜¯ä¸º STM32F103 å¼€å‘çš„ MPU6050 å…­è½´ä¼ æ„Ÿå™¨ï¼ˆåŠ é€Ÿåº¦è®¡+é™€èºä»ªï¼‰é©±åŠ¨åº“ã€‚

**ç‰¹ç‚¹ï¼š**
- âœ… åŸºäºç¡¬ä»¶ I2C é€šä¿¡ï¼ˆI2C1ï¼‰
- âœ… å®Œæ•´çš„åŠ é€Ÿåº¦è®¡å’Œé™€èºä»ªæ•°æ®è¯»å–
- âœ… å†…ç½®æ¸©åº¦ä¼ æ„Ÿå™¨æ”¯æŒ
- âœ… è‡ªåŠ¨è®¡ç®—å§¿æ€è§’ï¼ˆæ¨ªæ»šè§’ Rollã€ä¿¯ä»°è§’ Pitchï¼‰
- âœ… å‚è€ƒ MQ2 é©±åŠ¨çš„ä»£ç é£æ ¼ï¼Œç»“æ„æ¸…æ™°
- âœ… å®å®šä¹‰é…ç½®ï¼Œæ–¹ä¾¿ç§»æ¤å’Œä¿®æ”¹

---

## ğŸ”Œ ç¡¬ä»¶è¿æ¥

### MPU6050 å¼•è„šè¿æ¥

| MPU6050 å¼•è„š | STM32 å¼•è„š | è¯´æ˜ |
|-------------|-----------|------|
| VCC | 3.3V | ç”µæºæ­£æ |
| GND | GND | ç”µæºè´Ÿæ |
| SCL | PB6 | I2C1_SCLï¼ˆæ—¶é’Ÿçº¿ï¼‰|
| SDA | PB7 | I2C1_SDAï¼ˆæ•°æ®çº¿ï¼‰|
| AD0 | GND | I2Cåœ°å€é€‰æ‹©ï¼ˆæ¥åœ°=0xD0ï¼‰|

**æ³¨æ„äº‹é¡¹ï¼š**
1. MPU6050 å¿…é¡»ä½¿ç”¨ **3.3V** ä¾›ç”µï¼ˆä¸èƒ½ç”¨5Vï¼ï¼‰
2. SCL å’Œ SDA éœ€è¦ä¸Šæ‹‰ç”µé˜»ï¼ˆä¸€èˆ¬æ¨¡å—å·²è‡ªå¸¦ï¼‰
3. AD0 å¼•è„šæ¥ GND æ—¶ï¼ŒI2C åœ°å€ä¸º 0xD0ï¼ˆæœ¬é©±åŠ¨é»˜è®¤ï¼‰

---

## âš™ï¸ CubeMX é…ç½®

### 1. I2C1 é…ç½®
åœ¨ STM32CubeMX ä¸­é…ç½® I2C1ï¼š

```
Connectivity -> I2C1
â”œâ”€ Mode: I2C
â”œâ”€ I2C Speed: Standard Mode (100 KHz)
â”œâ”€ Pin Assignment:
â”‚  â”œâ”€ PB6 -> I2C1_SCL
â”‚  â””â”€ PB7 -> I2C1_SDA
```

### 2. æ—¶é’Ÿé…ç½®
ç¡®ä¿ APB1 æ—¶é’Ÿå·²æ­£ç¡®é…ç½®ï¼ˆI2C1 åœ¨ APB1 æ€»çº¿ä¸Šï¼‰

---

## ğŸ’» ä»£ç ä½¿ç”¨

### 1. åˆå§‹åŒ–

åœ¨ `main.c` ä¸­çš„åˆå§‹åŒ–éƒ¨åˆ†è°ƒç”¨ï¼š

```c
// åœ¨ USER CODE BEGIN 2 åŒºåŸŸ
MPU6050_Init();
printf("MPU6050 Init OK\r\n");
```

åˆå§‹åŒ–ä¼šï¼š
- æ£€æŸ¥è®¾å¤‡æ˜¯å¦å­˜åœ¨ï¼ˆWHO_AM_I å¯„å­˜å™¨ = 0x68ï¼‰
- é…ç½®é™€èºä»ªå’ŒåŠ é€Ÿåº¦è®¡é‡ç¨‹
- é…ç½®é‡‡æ ·ç‡å’Œæ»¤æ³¢å™¨
- å”¤é†’è®¾å¤‡ï¼ˆMPU6050 ä¸Šç”µé»˜è®¤ä¼‘çœ ï¼‰

### 2. åœ¨è°ƒåº¦å™¨ä¸­ä½¿ç”¨ï¼ˆæ¨èï¼‰

é©±åŠ¨å·²è‡ªåŠ¨é›†æˆåˆ°è°ƒåº¦å™¨ä¸­ï¼Œåœ¨ `scheduler.c` ä¸­ï¼š

```c
static task_t scheduler_task[] =
{
    {dht11_task, 1000, 0},
    {mpu6050_task, 100, 0}, // æ¯100msè¯»å–ä¸€æ¬¡MPU6050
};
```

### 3. æ‰‹åŠ¨è¯»å–æ•°æ®

```c
// æ›´æ–°æ•°æ®
if (MPU6050_Update() == MPU6050_OK)
{
    // è¯»å–åŠ é€Ÿåº¦ï¼ˆå•ä½ï¼šgï¼‰
    float ax = mpu6050_data.accel_x_g;
    float ay = mpu6050_data.accel_y_g;
    float az = mpu6050_data.accel_z_g;
    
    // è¯»å–è§’é€Ÿåº¦ï¼ˆå•ä½ï¼šÂ°/sï¼‰
    float gx = mpu6050_data.gyro_x_dps;
    float gy = mpu6050_data.gyro_y_dps;
    float gz = mpu6050_data.gyro_z_dps;
    
    // è¯»å–æ¸©åº¦ï¼ˆå•ä½ï¼šÂ°Cï¼‰
    float temp = mpu6050_data.temperature;
    
    // è¯»å–å§¿æ€è§’ï¼ˆå•ä½ï¼šÂ°ï¼‰
    float roll = mpu6050_data.roll;   // æ¨ªæ»šè§’
    float pitch = mpu6050_data.pitch; // ä¿¯ä»°è§’
    
    printf("Roll: %.2fÂ°, Pitch: %.2fÂ°\r\n", roll, pitch);
}
```

### 4. è·å–ç‰¹å®šæ•°æ®

```c
// ä½¿ç”¨ä¾¿æ·å‡½æ•°
float temperature = MPU6050_GetTemperature();
float roll = MPU6050_GetRoll();
float pitch = MPU6050_GetPitch();
```

---

## ğŸ“Š æ•°æ®ç»“æ„

### MPU6050_Data_t

```c
typedef struct {
    // åŸå§‹æ•°æ®ï¼ˆ16ä½æœ‰ç¬¦å·æ•´æ•°ï¼‰
    int16_t accel_x_raw, accel_y_raw, accel_z_raw;  // åŠ é€Ÿåº¦åŸå§‹å€¼
    int16_t gyro_x_raw, gyro_y_raw, gyro_z_raw;     // é™€èºä»ªåŸå§‹å€¼
    int16_t temp_raw;                                // æ¸©åº¦åŸå§‹å€¼
    
    // è½¬æ¢åçš„ç‰©ç†æ•°æ®
    float accel_x_g, accel_y_g, accel_z_g;         // åŠ é€Ÿåº¦ï¼ˆgï¼‰
    float gyro_x_dps, gyro_y_dps, gyro_z_dps;      // è§’é€Ÿåº¦ï¼ˆÂ°/sï¼‰
    float temperature;                              // æ¸©åº¦ï¼ˆÂ°Cï¼‰
    
    // å§¿æ€è§’ï¼ˆåŸºäºåŠ é€Ÿåº¦è®¡è®¡ç®—ï¼‰
    float roll;                                     // æ¨ªæ»šè§’ï¼ˆÂ°ï¼‰
    float pitch;                                    // ä¿¯ä»°è§’ï¼ˆÂ°ï¼‰
} MPU6050_Data_t;

// å…¨å±€æ•°æ®å˜é‡
extern MPU6050_Data_t mpu6050_data;
```

---

## ğŸ¯ é‡ç¨‹é…ç½®

### åŠ é€Ÿåº¦è®¡é‡ç¨‹ï¼ˆåœ¨ mpu_app.h ä¸­ä¿®æ”¹ï¼‰

```c
// å¯é€‰å€¼ï¼š
#define MPU6050_ACCEL_SCALE_2G      0x00  // Â±2gï¼ˆé»˜è®¤ï¼‰
#define MPU6050_ACCEL_SCALE_4G      0x08  // Â±4g
#define MPU6050_ACCEL_SCALE_8G      0x10  // Â±8g
#define MPU6050_ACCEL_SCALE_16G     0x18  // Â±16g

// å½“å‰ä½¿ç”¨ï¼ˆå¯ä¿®æ”¹ï¼‰ï¼š
#define MPU6050_ACCEL_SCALE         MPU6050_ACCEL_SCALE_2G
```

### é™€èºä»ªé‡ç¨‹ï¼ˆåœ¨ mpu_app.h ä¸­ä¿®æ”¹ï¼‰

```c
// å¯é€‰å€¼ï¼š
#define MPU6050_GYRO_SCALE_250      0x00  // Â±250Â°/sï¼ˆé»˜è®¤ï¼‰
#define MPU6050_GYRO_SCALE_500      0x08  // Â±500Â°/s
#define MPU6050_GYRO_SCALE_1000     0x10  // Â±1000Â°/s
#define MPU6050_GYRO_SCALE_2000     0x18  // Â±2000Â°/s

// å½“å‰ä½¿ç”¨ï¼ˆå¯ä¿®æ”¹ï¼‰ï¼š
#define MPU6050_GYRO_SCALE          MPU6050_GYRO_SCALE_250
```

**é‡ç¨‹é€‰æ‹©å»ºè®®ï¼š**
- é™æ€å§¿æ€æ£€æµ‹ï¼šÂ±2g åŠ é€Ÿåº¦ + Â±250Â°/s é™€èºä»ª
- æ™®é€šè¿åŠ¨æ£€æµ‹ï¼šÂ±4g åŠ é€Ÿåº¦ + Â±500Â°/s é™€èºä»ª
- å‰§çƒˆè¿åŠ¨/å†²å‡»ï¼šÂ±8g/Â±16g åŠ é€Ÿåº¦ + Â±1000Â°/s/Â±2000Â°/s é™€èºä»ª

---

## ğŸ”§ å¸¸ç”¨å‡½æ•°

| å‡½æ•°å | åŠŸèƒ½ | è¿”å›å€¼ |
|--------|------|--------|
| `MPU6050_Init()` | åˆå§‹åŒ– MPU6050 | `MPU6050_Status_t` |
| `MPU6050_Update()` | æ›´æ–°ä¼ æ„Ÿå™¨æ•°æ® | `MPU6050_Status_t` |
| `MPU6050_PrintInfo()` | ä¸²å£æ‰“å°æ‰€æœ‰æ•°æ® | æ—  |
| `MPU6050_GetTemperature()` | è·å–æ¸©åº¦ | `float` |
| `MPU6050_GetRoll()` | è·å–æ¨ªæ»šè§’ | `float` |
| `MPU6050_GetPitch()` | è·å–ä¿¯ä»°è§’ | `float` |
| `mpu6050_task()` | ä»»åŠ¡å‡½æ•°ï¼ˆä¾›è°ƒåº¦å™¨è°ƒç”¨ï¼‰| æ—  |

### è¿”å›çŠ¶æ€æšä¸¾

```c
typedef enum {
    MPU6050_OK = 0,         // æ“ä½œæˆåŠŸ
    MPU6050_ERROR,          // ä¸€èˆ¬é”™è¯¯
    MPU6050_TIMEOUT,        // é€šä¿¡è¶…æ—¶
    MPU6050_NOT_FOUND       // è®¾å¤‡æœªæ‰¾åˆ°
} MPU6050_Status_t;
```

---

## ğŸ› è°ƒè¯•ä¸æ•…éšœæ’é™¤

### 1. åˆå§‹åŒ–å¤±è´¥

**ç°è±¡ï¼š** `[MPU6050] Device Not Found!`

**åŸå› ä¸è§£å†³ï¼š**
- âœ… æ£€æŸ¥ç¡¬ä»¶è¿æ¥ï¼ˆSCLã€SDA æ˜¯å¦æ­£ç¡®ï¼‰
- âœ… ç¡®è®¤ I2C åœ°å€ï¼ˆAD0=GND æ—¶ä¸º 0xD0ï¼‰
- âœ… æ£€æŸ¥ä¸Šæ‹‰ç”µé˜»ï¼ˆæ¨¡å—æ˜¯å¦æœ‰ä¸Šæ‹‰ç”µé˜»ï¼‰
- âœ… ç”¨ç¤ºæ³¢å™¨/é€»è¾‘åˆ†æä»ªæ£€æŸ¥ I2C æ³¢å½¢
- âœ… ç¡®è®¤ MPU6050 ä¾›ç”µæ­£å¸¸ï¼ˆ3.3Vï¼‰

### 2. é€šä¿¡è¶…æ—¶

**ç°è±¡ï¼š** `[MPU6050] Communication Error!` æˆ– `Update Failed!`

**åŸå› ä¸è§£å†³ï¼š**
- âœ… I2C æ—¶é’Ÿé€Ÿåº¦è¿‡é«˜ï¼ˆé™ä½åˆ° 100kHzï¼‰
- âœ… çº¿ç¼†è¿‡é•¿æˆ–å¹²æ‰°ä¸¥é‡
- âœ… æ£€æŸ¥ CubeMX ä¸­ I2C é…ç½®

### 3. æ•°æ®ä¸ç¨³å®š

**åŸå› ä¸è§£å†³ï¼š**
- âœ… å¢åŠ æ»¤æ³¢å™¨ï¼ˆåœ¨åˆå§‹åŒ–ä¸­å·²é…ç½®ä½é€šæ»¤æ³¢ï¼‰
- âœ… è½¯ä»¶æ»‘åŠ¨å¹³å‡æ»¤æ³¢
- âœ… æ£€æŸ¥ç”µæºçº¹æ³¢

### 4. è§’åº¦è®¡ç®—ä¸å‡†ç¡®

**è¯´æ˜ï¼š**
- å½“å‰è§’åº¦ä»…åŸºäºåŠ é€Ÿåº¦è®¡è®¡ç®—ï¼ˆé™æ€å‡†ç¡®ï¼ŒåŠ¨æ€æœ‰è¯¯å·®ï¼‰
- å¦‚éœ€é«˜ç²¾åº¦å§¿æ€ï¼Œéœ€å®ç°äº’è¡¥æ»¤æ³¢æˆ–å¡å°”æ›¼æ»¤æ³¢ï¼ˆèåˆé™€èºä»ªæ•°æ®ï¼‰

---

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹ 1ï¼šæ£€æµ‹è®¾å¤‡å€¾æ–œ

```c
void check_tilt(void)
{
    if (MPU6050_Update() == MPU6050_OK)
    {
        if (fabs(mpu6050_data.roll) > 30.0f)
        {
            printf("è­¦å‘Šï¼šè®¾å¤‡å‘å·¦/å³å€¾æ–œè¶…è¿‡30åº¦ï¼\r\n");
        }
        
        if (fabs(mpu6050_data.pitch) > 30.0f)
        {
            printf("è­¦å‘Šï¼šè®¾å¤‡å‘å‰/åå€¾æ–œè¶…è¿‡30åº¦ï¼\r\n");
        }
    }
}
```

### ç¤ºä¾‹ 2ï¼šæ£€æµ‹éœ‡åŠ¨/å†²å‡»

```c
void detect_vibration(void)
{
    if (MPU6050_Update() == MPU6050_OK)
    {
        // è®¡ç®—åŠ é€Ÿåº¦å¹…å€¼ï¼ˆå»é™¤é‡åŠ›ï¼‰
        float accel_mag = sqrtf(mpu6050_data.accel_x_g * mpu6050_data.accel_x_g +
                                mpu6050_data.accel_y_g * mpu6050_data.accel_y_g +
                                mpu6050_data.accel_z_g * mpu6050_data.accel_z_g);
        
        // æ£€æµ‹å†²å‡»ï¼ˆå¹…å€¼è¿œå¤§äº1gï¼‰
        if (accel_mag > 2.0f)
        {
            printf("æ£€æµ‹åˆ°å†²å‡»ï¼åŠ é€Ÿåº¦: %.2fg\r\n", accel_mag);
        }
    }
}
```

### ç¤ºä¾‹ 3ï¼šæ¸©åº¦ç›‘æ§

```c
void monitor_temperature(void)
{
    float temp = MPU6050_GetTemperature();
    
    if (temp > 60.0f)
    {
        printf("è­¦å‘Šï¼šæ¸©åº¦è¿‡é«˜ï¼%.2fÂ°C\r\n", temp);
    }
    else if (temp < -10.0f)
    {
        printf("è­¦å‘Šï¼šæ¸©åº¦è¿‡ä½ï¼%.2fÂ°C\r\n", temp);
    }
    else
    {
        printf("æ¸©åº¦æ­£å¸¸ï¼š%.2fÂ°C\r\n", temp);
    }
}
```

---

## ğŸ“š æ–‡ä»¶ç»“æ„

```
APP/
â”œâ”€â”€ mpu_app.h       # MPU6050 é©±åŠ¨å¤´æ–‡ä»¶ï¼ˆé…ç½®ã€å®å®šä¹‰ã€æ•°æ®ç»“æ„ï¼‰
â””â”€â”€ mpu_app.c       # MPU6050 é©±åŠ¨å®ç°ï¼ˆåˆå§‹åŒ–ã€é€šä¿¡ã€è®¡ç®—ï¼‰

Core/Inc/
â””â”€â”€ i2c.h           # I2C HAL åº“å¤´æ–‡ä»¶

Core/Src/
â”œâ”€â”€ i2c.c           # I2C HAL åº“å®ç°
â””â”€â”€ main.c          # ä¸»ç¨‹åºï¼ˆè°ƒç”¨ MPU6050_Initï¼‰

APP/
â”œâ”€â”€ scheduler.c     # ä»»åŠ¡è°ƒåº¦å™¨ï¼ˆåŒ…å« mpu6050_taskï¼‰
â””â”€â”€ bsp_system.h    # ç³»ç»Ÿå¤´æ–‡ä»¶ï¼ˆåŒ…å« mpu_app.hï¼‰
```

---

## âš¡ æ€§èƒ½å‚æ•°

| å‚æ•° | å€¼ |
|------|-----|
| I2C é€Ÿåº¦ | 100 kHzï¼ˆæ ‡å‡†æ¨¡å¼ï¼‰|
| é‡‡æ ·ç‡ | 100 Hz |
| æ›´æ–°å‘¨æœŸ | 100 msï¼ˆå¯åœ¨ scheduler.c ä¸­ä¿®æ”¹ï¼‰|
| æ•°æ®è¯»å–æ—¶é—´ | < 2 ms |
| ä½é€šæ»¤æ³¢å™¨å¸¦å®½ | 94 Hz |

---

## ğŸ“– å‚è€ƒèµ„æ–™

- [MPU6050 æ•°æ®æ‰‹å†Œ](https://invensense.tdk.com/wp-content/uploads/2015/02/MPU-6000-Datasheet1.pdf)
- [MPU6050 å¯„å­˜å™¨æ‰‹å†Œ](https://invensense.tdk.com/wp-content/uploads/2015/02/MPU-6000-Register-Map1.pdf)
- STM32F103 HAL åº“æ–‡æ¡£

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š
1. ç¡¬ä»¶è¿æ¥æ˜¯å¦æ­£ç¡®
2. CubeMX é…ç½®æ˜¯å¦å®Œæ•´
3. ä¸²å£è¾“å‡ºçš„é”™è¯¯ä¿¡æ¯
4. ä½¿ç”¨ç¤ºæ³¢å™¨/é€»è¾‘åˆ†æä»ªæ£€æŸ¥ I2C é€šä¿¡

---

**ç‰ˆæœ¬ï¼š** v1.0  
**ä½œè€…ï¼š** AI Assistant  
**æ—¥æœŸï¼š** 2025/11/11  
**è®¸å¯ï¼š** MIT License

