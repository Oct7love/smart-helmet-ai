# MPU6050 计步器调试指南

## 📋 目录
1. [工作原理](#工作原理)
2. [快速调试](#快速调试)
3. [参数调整](#参数调整)
4. [常见问题](#常见问题)
5. [测试方法](#测试方法)

---

## 🔍 工作原理

### 双重计步算法

本系统采用**DMP硬件计步器 + 软件辅助计步器**的双重方案：

```
┌─────────────────┐     ┌──────────────────┐
│  DMP硬件计步器   │     │  软件辅助计步器   │
│  (固件算法)     │     │  (加速度波峰)    │
└────────┬────────┘     └────────┬─────────┘
         │                       │
         └───────┬───────────────┘
                 ↓
         取两者中较大值 → 最终步数
```

### 检测原理

**软件算法检测走路时的加速度变化：**

```
加速度变化(g)
    ↑
1.2 │    /\      /\      /\
    │   /  \    /  \    /  \
1.0 │──/────\──/────\──/────\──
    │       \/      \/      \/
0.8 │
    └───────────────────────────→ 时间
         步1    步2    步3

检测逻辑：
1. 计算加速度矢量: √(X² + Y² + Z²)
2. 检测变化量: |当前值 - 上次值|
3. 判断: 变化 > 阈值 + 时间间隔 > 最小间隔 → 计步+1
```

---

## ⚡ 快速调试

### 1. 查看当前配置

打开 `APP/mpu_app.h`，找到计步器配置：

```c
/* 计步器配置 ----------------------------------------------------------------*/
#define MPU6050_STEP_LENGTH         0.3f            // 步距（米）默认30cm
#define MPU6050_SOFT_STEP_THRESHOLD 0.15f           // 软件计步阈值（g）
#define MPU6050_STEP_MIN_INTERVAL   250             // 最小步伐间隔(ms)
```

### 2. 串口输出说明

正常运行时，每秒打印一次数据：

```
--- MPU6050 数据 ---
温度: 32.4°C
姿态: Pitch=-9.7° Roll=-96.6° Yaw=-111.7°
加速度: X=0.375g Y=-0.828g Z=-0.463g (SVM=16710)
计步器: 步数=50  距离=17.50m (0.018km)
✓ 新增 3 步！                          ← 步数变化提示
-------------------
```

### 3. 统计信息

每100次成功更新打印一次统计：

```
[统计] 成功:100 失败:5 失败率:4.8%
```

**失败率参考：**
- ✅ 0-5%：优秀，稳定
- ✅ 5-10%：良好，可接受
- ⚠️ 10-20%：一般，检查连接
- ❌ >20%：较差，需检查硬件

---

## 🎚️ 参数调整

### 核心参数说明

| 参数 | 作用 | 默认值 | 推荐范围 | 影响 |
|------|------|--------|---------|------|
| `MPU6050_SOFT_STEP_THRESHOLD` | 检测阈值 | 0.15g | 0.10~0.25g | 灵敏度 |
| `MPU6050_STEP_MIN_INTERVAL` | 防抖间隔 | 250ms | 150~400ms | 误触发 |
| `MPU6050_STEP_LENGTH` | 单步距离 | 0.3m | 0.25~0.8m | 距离计算 |

### 调整策略

#### 场景1：太灵敏（误计步太多）

**症状：**
- 手持晃动就计步
- 坐着不动也增加步数
- 10步实际计数20+

**解决方案：**

```c
// 方案A：提高阈值（推荐）
#define MPU6050_SOFT_STEP_THRESHOLD 0.20f   // 0.15 → 0.20

// 方案B：增加防抖时间
#define MPU6050_STEP_MIN_INTERVAL   350     // 250 → 350

// 方案C：两者结合
#define MPU6050_SOFT_STEP_THRESHOLD 0.18f
#define MPU6050_STEP_MIN_INTERVAL   300
```

#### 场景2：不够灵敏（漏计步）

**症状：**
- 正常走路不计步
- 10步只计数3-5步
- 需要用力跺脚才计步

**解决方案：**

```c
// 方案A：降低阈值（推荐）
#define MPU6050_SOFT_STEP_THRESHOLD 0.12f   // 0.15 → 0.12

// 方案B：缩短防抖时间
#define MPU6050_STEP_MIN_INTERVAL   200     // 250 → 200

// 方案C：两者结合
#define MPU6050_SOFT_STEP_THRESHOLD 0.10f
#define MPU6050_STEP_MIN_INTERVAL   180
```

#### 场景3：调整步距

根据身高调整步距（更准确的距离计算）：

```c
// 成人步距参考
#define MPU6050_STEP_LENGTH 0.45f  // 身高170-180cm
#define MPU6050_STEP_LENGTH 0.50f  // 身高180-190cm
#define MPU6050_STEP_LENGTH 0.40f  // 身高160-170cm
#define MPU6050_STEP_LENGTH 0.30f  // 儿童/慢走

// 精确计算公式
步距(m) ≈ 身高(cm) × 0.0025
例如：175cm → 0.44m
```

---

## 🐛 常见问题

### Q1: 为什么原地不动也在计步？

**原因：**
- 阈值设置太低
- 环境振动（桌子、车辆）
- 设备未固定

**解决：**
1. 提高 `MPU6050_SOFT_STEP_THRESHOLD` 到 0.20g
2. 固定设备（不要手持晃动）
3. 增加 `MPU6050_STEP_MIN_INTERVAL` 到 300ms

### Q2: 为什么走路不计步？

**原因：**
- 阈值设置太高
- 走路动作太小（拖着脚走）
- 设备方向不对

**解决：**
1. 降低 `MPU6050_SOFT_STEP_THRESHOLD` 到 0.12g
2. 检查佩戴位置（见Q5）
3. 正常抬腿走路（不要拖步）

### Q3: DMP计步器和软件计步器有什么区别？

| 对比项 | DMP硬件计步器 | 软件辅助计步器 |
|--------|--------------|---------------|
| **算法位置** | MPU6050芯片内部 | STM32软件计算 |
| **灵敏度** | 固定（无法调整） | 可调（修改宏定义） |
| **功耗** | 低 | 较高 |
| **准确度** | 较高（复杂算法） | 一般（简单算法） |
| **优点** | 稳定、省电 | 灵活、可调 |

**本系统策略：取两者中较大值** → 既稳定又灵敏

### Q4: 如何禁用软件计步器，只用DMP？

修改 `APP/mpu_app.c` 第179行：

```c
// 原来（双重计步）
mpu6050_data.step_count = (soft_step_count > steps) ? soft_step_count : steps;

// 修改为（仅DMP）
mpu6050_data.step_count = steps;
```

### Q5: 正确的佩戴方式？

**推荐佩戴位置：**

```
方式1：腰部佩戴（最佳）
   人体侧面
      │
   ┌──┴──┐
   │ 腰带 │
   │[MPU]│ ← Z轴垂直向下
   └─────┘

方式2：胸口佩戴
   ┌─────┐
   │[MPU]│ ← 芯片面朝外
   │ 胸口 │
   └─────┘

方式3：口袋佩戴
   ┌─────┐
   │ 手机 │
   │[MPU]│ ← 固定在手机上
   │ 口袋 │
   └─────┘
```

**❌ 错误方式：**
- 手持晃动（误触发严重）
- 背包里松动（振动过大）
- 倒置放置（Z轴方向错误）

### Q6: 数据更新失败率高怎么办？

如果看到 `失败率 > 10%`：

1. **检查I2C速度**（`Core/Src/i2c.c`）：
   ```c
   hi2c1.Init.ClockSpeed = 50000;  // 当前50kHz
   // 如果失败率高，可降低到：
   hi2c1.Init.ClockSpeed = 30000;  // 降低到30kHz
   ```

2. **检查硬件连接：**
   - SCL/SDA线是否松动
   - 上拉电阻是否正常（2.2kΩ-10kΩ）
   - VCC电压是否稳定（3.3V）

3. **检查距离：**
   - I2C线长度 < 20cm（理想）
   - 避免与电机等干扰源并行走线

---

## 🧪 测试方法

### 标准测试流程

#### 测试1：静态测试（检测误触发）

```
步骤：
1. 设备平放在桌面
2. 保持静止5分钟
3. 观察步数变化

预期结果：
✅ 步数应保持0或变化 < 3步
❌ 如果步数持续增加 → 阈值太低，需调高
```

#### 测试2：行走测试（检测灵敏度）

```
步骤：
1. 设备固定在腰部/口袋
2. 正常走路20步（数清楚）
3. 对比实际步数和显示步数

预期结果：
✅ 误差 ≤ 10%（18-22步）→ 合格
⚠️ 误差 10-20%（16-24步）→ 可接受
❌ 误差 > 20% → 需要调整参数
```

#### 测试3：快走测试（检测响应速度）

```
步骤：
1. 快速行走（每秒2-3步）
2. 观察是否能及时计步

预期结果：
✅ 能跟上快速步伐
❌ 计步明显滞后 → 降低 STEP_MIN_INTERVAL
```

#### 测试4：防抖测试（检测误触发）

```
步骤：
1. 手持设备轻微晃动
2. 观察是否误计步

预期结果：
✅ 轻微晃动不计步
❌ 稍微晃动就计步 → 提高 STEP_MIN_INTERVAL
```

### 参数调优记录表

建议记录测试结果，找到最优参数：

| 测试 | 阈值(g) | 间隔(ms) | 实际步数 | 显示步数 | 误差 | 评价 |
|------|---------|---------|---------|---------|------|------|
| 1 | 0.15 | 250 | 20 | 15 | -25% | 太低 |
| 2 | 0.12 | 250 | 20 | 19 | -5% | 良好 ✅ |
| 3 | 0.10 | 250 | 20 | 28 | +40% | 太高 |
| ... | ... | ... | ... | ... | ... | ... |

---

## 🔧 高级调试

### 实时查看加速度变化

如需观察加速度波形，可添加调试输出：

在 `APP/mpu_app.c` 的 `MPU6050_Update()` 函数中：

```c
// 在第177行后添加
printf("加速度变化: %.3fg (阈值: %.3fg)\r\n", 
       accel_change, MPU6050_SOFT_STEP_THRESHOLD);
```

输出示例：
```
加速度变化: 0.052g (阈值: 0.15g)  ← 未超过阈值
加速度变化: 0.182g (阈值: 0.15g)  ← 超过阈值，计步+1
加速度变化: 0.134g (阈值: 0.15g)  ← 未超过阈值
```

### 查看DMP vs 软件计步对比

在 `mpu6050_task()` 函数中添加：

```c
printf("DMP步数: %lu, 软件步数: %lu, 最终: %lu\r\n",
       steps, soft_step_count, mpu6050_data.step_count);
```

---

## 📝 版本历史

| 版本 | 日期 | 修改内容 |
|------|------|---------|
| v1.0 | 2025/11/11 | 初始版本，双重计步算法 |
| v1.1 | 2025/11/11 | 优化阈值，降低到0.15g |
| v1.2 | 2025/11/11 | 添加统计信息输出 |

---

## 💡 最佳实践建议

1. **先用默认参数测试**
   - 阈值: 0.15g
   - 间隔: 250ms
   - 步距: 0.35m

2. **根据实际使用场景调整**
   - 老年人/儿童 → 降低阈值
   - 剧烈运动 → 提高阈值
   - 慢走 → 增加间隔

3. **定期校准**
   - 每次使用前重置步数
   - 根据身高调整步距

4. **环境要求**
   - 固定佩戴（不要手持）
   - 避免剧烈振动环境
   - 正常抬腿行走

---

## 📞 技术支持

如有问题，请检查：
1. 硬件连接是否正常
2. I2C通信失败率是否 < 10%
3. 参数配置是否合理
4. 佩戴方式是否正确

**调试建议优先级：**
1. ⭐⭐⭐ 调整 `SOFT_STEP_THRESHOLD`（最有效）
2. ⭐⭐ 调整 `STEP_MIN_INTERVAL`（防误触发）
3. ⭐ 调整 `STEP_LENGTH`（准确距离）

---

**祝调试顺利！🎉**




