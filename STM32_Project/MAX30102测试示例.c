/**
  ******************************************************************************
  * @file           : MAX30102测试示例.c
  * @brief          : MAX30102心率血氧传感器测试代码
  * @author         : 13615
  * @date           : 2025/11/11
  * @version        : v1.0
  ******************************************************************************
  * 使用说明：
  * 1. 将此代码复制到 Core/Src/main.c 的相应位置
  * 2. 编译并下载到STM32
  * 3. 将手指放在MAX30102传感器上
  * 4. 通过串口查看心率和血氧数据
  ******************************************************************************
  */

/* 在 main.c 开头添加头文件 */
#include "max30102_app.h"

/* ============================================================================
   方法1：在main函数中周期调用（推荐新手）
   ============================================================================ */
int main(void)
{
    HAL_Init();
    SystemClock_Config();
    
    /* 初始化外设 */
    MX_GPIO_Init();
    MX_DMA_Init();
    MX_USART1_UART_Init();  // 串口用于打印信息
    MX_I2C1_Init();         // MPU6050使用
    MX_I2C2_Init();         // MAX30102使用
    
    printf("\r\n========================================\r\n");
    printf("MAX30102 心率血氧传感器测试程序\r\n");
    printf("========================================\r\n");
    
    /* 初始化MAX30102 */
    if (MAX30102_Init()) {
        printf("✓ MAX30102初始化成功!\r\n");
    } else {
        printf("✗ MAX30102初始化失败! 请检查:\r\n");
        printf("  1. 硬件连接是否正确\r\n");
        printf("  2. I2C2引脚配置(PB10/PB11)\r\n");
        printf("  3. 模块供电(3.3V)\r\n");
        while(1) {
            HAL_Delay(1000);  // 初始化失败则停止
        }
    }
    
    printf("\r\n请将手指放在传感器上...\r\n\r\n");
    HAL_Delay(1000);
    
    /* 主循环 */
    while (1)
    {
        /* 更新传感器数据(建议20-50ms周期) */
        MAX30102_Update();
        
        /* 打印心率血氧信息 */
        MAX30102_PrintInfo();
        
        /* 可选：单独获取数据 */
        // float hr = MAX30102_GetHeartRate();
        // float spo2 = MAX30102_GetSpO2();
        // bool finger = MAX30102_IsFingerDetected();
        // printf("心率: %.1f bpm, 血氧: %.1f%%\r\n", hr, spo2);
        
        HAL_Delay(50);  // 50ms更新周期
    }
}


/* ============================================================================
   方法2：使用调度器周期调用（推荐进阶）
   ============================================================================ */
#include "scheduler.h"
#include "max30102_app.h"

/* 在main函数初始化部分添加 */
void setup_max30102_task(void)
{
    /* 初始化MAX30102 */
    if (!MAX30102_Init()) {
        printf("MAX30102初始化失败!\r\n");
        return;
    }
    
    /* 注册到调度器，50ms周期执行 */
    scheduler_add_task(max30102_task, 50);
}

/* 在main函数中调用 */
int main(void)
{
    /* ... 系统初始化 ... */
    
    MX_I2C1_Init();
    MX_I2C2_Init();
    
    setup_max30102_task();  // 设置MAX30102任务
    
    while (1)
    {
        scheduler_run();  // 运行调度器
    }
}


/* ============================================================================
   方法3：集成到现有项目（与其他传感器一起使用）
   ============================================================================ */
#include "mpu_app.h"
#include "dht11_app.h"
#include "mq2_app.h"
#include "max30102_app.h"

int main(void)
{
    /* ... 系统初始化 ... */
    
    MX_I2C1_Init();
    MX_I2C2_Init();
    MX_ADC1_Init();
    
    /* 初始化所有传感器 */
    MPU6050_DMP_Init();     // MPU6050 (I2C1)
    DHT11_Init();           // DHT11
    MQ2_Init();             // MQ2
    MAX30102_Init();        // MAX30102 (I2C2)
    
    /* 注册所有任务到调度器 */
    scheduler_add_task(mpu6050_task, 20);      // 20ms
    scheduler_add_task(dht11_task, 2000);      // 2s
    scheduler_add_task(mq2_task, 500);         // 500ms
    scheduler_add_task(max30102_task, 50);     // 50ms
    
    printf("所有传感器初始化完成!\r\n");
    
    while (1)
    {
        scheduler_run();
    }
}


/* ============================================================================
   串口输出示例
   ============================================================================ */
/*
输出格式1（有手指）：
HR: 72.5 bpm | SpO2: 98.2% | Signal: 90%

输出格式2（无手指）：
No finger detected!

详细输出（可自定义）：
========================================
MAX30102 传感器数据
========================================
手指检测: 是
红光原始值: 145820
红外原始值: 158650
心率: 72.5 bpm
血氧饱和度: 98.2%
信号质量: 90%
========================================
*/


/* ============================================================================
   高级功能示例：自定义数据处理
   ============================================================================ */
void advanced_max30102_demo(void)
{
    MAX30102_Update();
    
    /* 获取数据结构 */
    extern MAX30102_Data_t max30102_data;
    
    /* 访问原始数据 */
    uint32_t red = max30102_data.red;
    uint32_t ir = max30102_data.ir;
    
    /* 访问AC/DC分量 */
    float red_ac = max30102_data.red_ac;
    float red_dc = max30102_data.red_dc;
    
    /* 访问计算结果 */
    float hr = max30102_data.heart_rate;
    float spo2 = max30102_data.spo2;
    float ratio = max30102_data.ratio;
    
    /* 信号质量评估 */
    if (max30102_data.signal_quality > 80) {
        printf("信号质量：优秀\r\n");
    } else if (max30102_data.signal_quality > 50) {
        printf("信号质量：良好\r\n");
    } else {
        printf("信号质量：较差，请调整手指位置\r\n");
    }
    
    /* 健康状态判断 */
    if (max30102_data.finger_detected) {
        if (hr > 100) {
            printf("⚠️ 心率偏高!\r\n");
        } else if (hr < 60) {
            printf("⚠️ 心率偏低!\r\n");
        }
        
        if (spo2 < 95.0f) {
            printf("⚠️ 血氧偏低!\r\n");
        }
    }
}


/* ============================================================================
   配置参数说明（在 max30102_app.h 中修改）
   ============================================================================ */
/*
采样率配置：
#define MAX30102_SAMPLE_RATE       100    // 50/100/200/400 Hz

LED电流配置：
#define MAX30102_LED_CURRENT       0x1F   // 0x00-0xFF (0.2mA步进)
                                          // 0x1F ≈ 6.4mA (默认)
                                          // 增大电流可提高信号强度

滤波参数：
#define MAX30102_DC_FILTER_ALPHA   0.95f  // 直流滤波系数(0-1)
#define MAX30102_MEAN_FILTER_SIZE  15     // 均值滤波窗口大小

数据有效范围：
#define MAX30102_HR_MIN            40.0f  // 最小心率(bpm)
#define MAX30102_HR_MAX            200.0f // 最大心率(bpm)
#define MAX30102_SPO2_MIN          70.0f  // 最小血氧(%)
#define MAX30102_SPO2_MAX          100.0f // 最大血氧(%)
*/


/* ============================================================================
   常见问题处理
   ============================================================================ */
/*
问题1：初始化失败
解决：
1. 检查I2C2配置（PB10/PB11）
2. 检查硬件连接
3. 检查模块供电（3.3V）
4. 确认器件地址（0xAE）

问题2：心率血氧读数为0
解决：
1. 确认手指正确放置在传感器上
2. 手指不要按压过紧或过松
3. 等待3-5秒让数据稳定
4. 检查LED是否发光（红光+红外）

问题3：数据波动大
解决：
1. 增大均值滤波窗口(MAX30102_MEAN_FILTER_SIZE)
2. 保持手指静止不动
3. 避免环境光干扰
4. 调整LED电流

问题4：信号质量差
解决：
1. 清洁传感器表面
2. 调整手指放置位置
3. 增大LED电流
4. 检查上拉电阻
*/

