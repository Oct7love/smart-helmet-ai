/**
  ******************************************************************************
  * @brief  MAX30102心率检测问题诊断代码
  * @note   将此代码添加到main.c的while(1)循环中替换原来的测试代码
  ******************************************************************************
  */

/* 在main.c的while(1)中使用以下代码 */

// 方案1：详细调试模式（找出问题原因）
void DEBUG_MODE(void)
{
    MAX30102_Update();
    
    // 每次循环打印详细信息
    MAX30102_PrintDebug();  // 显示原始数据和AC/DC分量
    MAX30102_PrintInfo();   // 显示心率血氧
    
    HAL_Delay(100);  // 100ms周期
}

// 方案2：简化测试模式
void SIMPLE_TEST(void)
{
    static uint8_t count = 0;
    
    MAX30102_Update();
    
    // 每10次打印一次(减少输出)
    if (++count >= 10) {
        count = 0;
        MAX30102_PrintInfo();
    }
    
    HAL_Delay(50);
}

/* ====================================================================
   完整示例代码
   ==================================================================== */

#include "max30102_app.h"

int main(void)
{
    HAL_Init();
    SystemClock_Config();
    
    MX_GPIO_Init();
    MX_USART1_UART_Init();
    MX_I2C1_Init();
    MX_I2C2_Init();
    
    printf("\r\n========================================\r\n");
    printf("MAX30102 心率检测诊断程序\r\n");
    printf("========================================\r\n");
    
    if (MAX30102_Init()) {
        printf("✓ 初始化成功\r\n");
        printf("请将手指放在传感器上...\r\n");
        printf("观察调试信息找出问题\r\n\r\n");
    } else {
        printf("✗ 初始化失败!\r\n");
        while(1);
    }
    
    HAL_Delay(1000);
    
    while (1)
    {
        /* 使用详细调试模式 */
        DEBUG_MODE();
        
        /* 或者使用简化测试模式 */
        // SIMPLE_TEST();
    }
}

/* ====================================================================
   预期的调试输出分析
   ==================================================================== */

/*
正常情况（应该看到）：
[DEBUG] IR:150000 Red:145000 | IR_AC:500.5 Red_AC:320.2 | IR_DC:149500.0 | Finger:1
HR(心率): 72.5 bpm | SpO2(血氧): 96.2% | Signal(信号质量): 90%

[DEBUG] IR:152000 Red:146000 | IR_AC:550.8 Red_AC:350.5 | IR_DC:151450.0 | Finger:1
HR(心率): 73.1 bpm | SpO2(血氧): 96.5% | Signal(信号质量): 90%

关键指标：
✓ IR: 100000-200000 (信号强度正常)
✓ IR_AC: 200-1000 (交流分量明显，说明有心跳波动)
✓ IR_DC: 接近IR值 (直流基线)
✓ Finger: 1 (检测到手指)

---

异常情况1：AC分量太小
[DEBUG] IR:150000 Red:145000 | IR_AC:20.5 Red_AC:15.2 | IR_DC:149980.0 | Finger:1
HR(心率): 0.0 bpm | SpO2(血氧): 96.2% | Signal(信号质量): 90%

问题：IR_AC只有20，太小了（正常应该>100）
原因：
1. 手指按压过紧，阻断血液流动
2. 手指位置不对，没有覆盖传感器
3. 手指过冷，血液循环差

解决：
- 放松按压力度
- 调整手指位置
- 搓热手指

---

异常情况2：信号太弱
[DEBUG] IR:30000 Red:28000 | IR_AC:50.2 Red_AC:40.1 | IR_DC:29950.0 | Finger:1
HR(心率): 0.0 bpm | SpO2(血氧): 89.2% | Signal(信号质量): 50%

问题：IR值太低（<50000）
原因：
1. 手指与传感器接触不良
2. LED电流太小
3. 传感器被遮挡

解决：
- 确保手指完全覆盖传感器
- 增大LED电流（修改MAX30102_LED_CURRENT）
- 检查硬件连接

---

异常情况3：完全没信号
[DEBUG] IR:0 Red:0 | IR_AC:0.0 Red_AC:0.0 | IR_DC:0.0 | Finger:0
No finger detected!

问题：IR和Red都是0
原因：
1. I2C通信失败
2. 传感器未初始化
3. 硬件连接错误

解决：
- 检查I2C2引脚配置
- 检查3.3V供电
- 检查SCL/SDA连接

---

异常情况4：数据异常大
[DEBUG] IR:262143 Red:262143 | IR_AC:100.5 Red_AC:80.2 | IR_DC:262040.0 | Finger:1
HR(心率): 0.0 bpm | SpO2(血氧): 70.2% | Signal(信号质量): 95%

问题：IR和Red都是262143（饱和值0x3FFFF）
原因：
1. LED电流过大
2. 环境光太强
3. 传感器故障

解决：
- 降低LED电流
- 遮挡传感器避免强光
- 检查传感器

*/

/* ====================================================================
   根据调试输出调整参数
   ==================================================================== */

/*
如果看到IR_AC很小（<100），可以尝试：

1. 降低检测阈值（max30102_app.h）：
#define MAX30102_PEAK_THRESHOLD    0.10f   // 进一步降低
#define MAX30102_MIN_AC_AMPLITUDE  30.0f   // 降低最小幅度要求

2. 增大LED电流（max30102_app.h）：
#define MAX30102_LED_CURRENT       0x3F    // 增大到0x3F (约12mA)

3. 减少滤波延迟（max30102_app.h）：
#define MAX30102_MEAN_FILTER_SIZE  3       // 进一步减小

4. 调整直流滤波系数（max30102_app.h）：
#define MAX30102_DC_FILTER_ALPHA   0.92f   // 降低,让DC更快跟随
*/

/* ====================================================================
   硬件检查清单
   ==================================================================== */

/*
如果软件调整无效，请检查硬件：

□ 1. 电源供电
   - 确认传感器VIN接3.3V（不是5V！）
   - 测量传感器VCC引脚电压是否为3.3V
   - 检查GND是否可靠连接

□ 2. I2C连接
   - 确认SCL接PB10
   - 确认SDA接PB11
   - 检查是否有上拉电阻（模块通常自带4.7kΩ）
   - 用示波器或逻辑分析仪检查I2C波形

□ 3. 传感器状态
   - 检查传感器是否发光（应该看到红光）
   - 清洁传感器表面（去除灰尘、油脂）
   - 确认传感器型号为MAX30102（不是MAX30100）

□ 4. 手指状态
   - 手指温度（搓热手指）
   - 手指清洁（洗手去除污渍）
   - 指甲盖朝上，指腹朝下
   - 覆盖整个传感器

□ 5. 环境因素
   - 避免强光直射传感器
   - 避免剧烈晃动
   - 保持安静测量3-5秒
*/

