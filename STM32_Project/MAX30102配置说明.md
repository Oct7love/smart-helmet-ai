# MAX30102 I2C2配置说明

## 📋 STM32CubeMX配置步骤

### 1️⃣ 打开项目配置文件
```
双击打开: STM32_Class_Project.ioc
```

### 2️⃣ 配置I2C2外设

#### **在左侧导航栏找到 Connectivity → I2C2**

#### **配置参数：**
- **I2C2 Mode**: I2C (模式选择)
- **I2C Speed Mode**: Standard Mode (标准模式100kHz) 或 Fast Mode (快速模式400kHz，推荐)

#### **具体配置项：**
```
I2C2 Configuration:
├─ Mode: I2C
├─ Clock Speed: 100000 Hz (或 400000 Hz)
├─ Duty Cycle: 2
├─ Own Address: 0
├─ Addressing Mode: 7-bit
└─ General Call: Disabled
```

### 3️⃣ GPIO引脚配置

#### **推荐引脚映射（根据您的硬件选择）：**

| 功能 | STM32F103引脚选项 | 推荐引脚 |
|------|------------------|---------|
| I2C2_SCL | PB10 / PB13 | **PB10** |
| I2C2_SDA | PB11 / PB14 | **PB11** |

#### **在Pinout视图中配置：**
1. 找到 **PB10** 引脚 → 设置为 `I2C2_SCL`
2. 找到 **PB11** 引脚 → 设置为 `I2C2_SDA`

### 4️⃣ 生成代码

1. 点击顶部 **Project → Generate Code**
2. 等待代码生成完成
3. 确认生成以下文件：
   - `Core/Inc/i2c.h` (新增 `extern I2C_HandleTypeDef hi2c2;`)
   - `Core/Src/i2c.c` (新增 `MX_I2C2_Init()` 函数)

---

## 🔌 硬件连接

### **MAX30102模块连接**
```
MAX30102模块    →    STM32F103
─────────────────────────────
VCC (3.3V)      →    3.3V
GND             →    GND
SCL             →    PB10 (I2C2_SCL)
SDA             →    PB11 (I2C2_SDA)
INT (可选)      →    不连接或连接到GPIO中断引脚
```

### **注意事项**
- ⚠️ MAX30102工作电压为**3.3V**，不要接5V！
- ⚠️ 建议SCL/SDA上拉4.7kΩ电阻（模块通常已集成）
- ⚠️ 模块与STM32共地

---

## ✅ 验证配置

### **检查生成的代码：**

#### **1. 检查 `Core/Inc/i2c.h`**
应包含：
```c
extern I2C_HandleTypeDef hi2c1;  // MPU6050使用
extern I2C_HandleTypeDef hi2c2;  // MAX30102使用
```

#### **2. 检查 `Core/Src/i2c.c`**
应包含：
```c
I2C_HandleTypeDef hi2c2;

void MX_I2C2_Init(void)
{
    hi2c2.Instance = I2C2;
    hi2c2.Init.ClockSpeed = 100000;  // 或400000
    // ... 其他配置
}
```

#### **3. 检查 `Core/Src/main.c`**
`main()` 函数中应包含：
```c
MX_I2C1_Init();  // MPU6050
MX_I2C2_Init();  // MAX30102 (新增)
```

---

## 🚀 使用MAX30102驱动

### **在 `main.c` 中初始化：**
```c
#include "max30102_app.h"

int main(void)
{
    HAL_Init();
    SystemClock_Config();
    
    MX_I2C1_Init();  // MPU6050
    MX_I2C2_Init();  // MAX30102
    
    // 初始化MAX30102
    if (MAX30102_Init()) {
        printf("MAX30102初始化成功!\r\n");
    } else {
        printf("MAX30102初始化失败!\r\n");
    }
    
    while (1)
    {
        // 更新传感器数据
        MAX30102_Update();
        
        // 打印心率血氧信息
        MAX30102_PrintInfo();
        
        HAL_Delay(20);  // 建议20-50ms更新周期
    }
}
```

---

## 📊 当前I2C分配

| I2C外设 | 引脚 | 使用设备 | 地址 | 时钟速度 |
|---------|------|---------|------|---------|
| **I2C1** | PB6/PB7 | MPU6050 | 0xD0 | 50kHz |
| **I2C2** | PB10/PB11 | MAX30102 | 0xAE | 100kHz (推荐400kHz) |

---

## 🛠️ 故障排查

### **编译错误：`hi2c2 undeclared`**
→ 说明CubeMX未正确生成I2C2代码，请重新配置并生成

### **初始化失败：`Wrong part ID`**
→ 检查硬件连接、I2C地址、上拉电阻

### **通信超时**
→ 检查引脚配置、时钟速度、电源供电

### **心率血氧读数为0**
→ 检查手指是否正确放置在传感器上

---

## 📝 配置完成后

完成CubeMX配置并生成代码后，请告诉我，我会继续完善MAX30102驱动代码！

